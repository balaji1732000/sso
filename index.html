<!DOCTYPE html>
<html>
<head>
  <title>Contoso Sample Web Chat</title> 
<script src="https://cdn.botframework.com/botframework-webchat/latest/webchat.js"></script>
<script type="text/javascript" src="https://alcdn.msauth.net/lib/1.2.0/js/msal.js"></script>
<script src="https://unpkg.com/@azure/storage-blob@10.3.0/browser/azure-storage.blob.min.js"
  integrity="sha384-fsfhtLyVQo3L3Bh73qgQoRR328xEeXnRGdoi53kjo1uectCfAHFfavrBBN2Nkbdf"
  crossorigin="anonymous"></script>
<script type="text/javascript">
  if (typeof Msal === 'undefined') document.write(unescape("%3Cscript src='https://alcdn.msftauth.net/lib/1.2.0/js/msal.js' type='text/javascript' %3E%3C/script%3E"));
</script>

  <style>
      html, body {
	  height: 100%;
      }

      body {
	  margin: 0;
      }

      h1 {
	  font-size: 16px;
	  font-family: Segoe UI;
	  line-height: 20px;
	  color: whitesmoke;
	  display: table-cell;
	  padding: 13px 0px 0px 20px;
      }

      #heading {
	  background-color: black;
	  height: 50px;
      }

      .main {
	  margin: 18px;
	  border-radius: 4px;
      }

      div[role="form"]{
	  background-color: black;
      }

      #webchat {
	  position: fixed;
	  height: calc(100% - 50px);
	  width: 100%;
	  top: 50px;
	  overflow: hidden;
      }
  #heading {
    background-color: black;
    background-repeat: no-repeat;
    background-size: cover;
    background-attachment: fixed;
    background-position: center;
    height: 50px;
    width: 100%;
    overflow: hidden;
    position: fixed;
  }

  h1 {
    font-size: 14px;
    font-family: Segoe UI;
    font-style: normal;
    font-weight: 600;
    font-size: 14px;
    line-height: 20px;
    color: #F3F2F1;
    letter-spacing: 0.005em;
    display: table-cell;
    vertical-align: middle;
    padding: 13px 0px 0px 20px;
  }

  #chatwindow {
    height: 80%;
    width: 100%;
    overflow: hidden;
    position: fixed;
  }

  #loginButton {

    height: 100px;
    width: 100%;
    position: fixed;
  }
  </style>

</head>
<body>
<div id="chatwindow">
  <div id="heading">
    <div><span>SSO Test Bot</span></div>
  </div>
  <div style="z-index: 100;position: absolute;margin-top: 50px;width: 100%;">
  <div>
    <label id="userName" name="userName" style="width:75%;height:15px;border-color: Transparent;">Not logged in.</label>
    <button id="login" name="login" onclick="onSignInClick()" style="float: right;background-color: aliceblue;">Log In</button>
  </div>
</div>
  <div id="webchat">
    <iframe src="https://copilotstudio.microsoft.com/environments/Default-f5791d91-daca-4d28-8700-680f7a2f8b6a/bots/cr90a_websiteQACopilotVMbQUS/webchat?__version__=2" frameborder="0" style="width: 100%; height: 100%;"></iframe>
  </div>

</div>

<script>
function onSignin(idToken) {
      let user = clientApplication.getAccount();
      console.log("onSignin invoked with idToken:", idToken);
      if (user) {
        document.getElementById("userName").innerHTML = "Currently logged in as " + user.name;
        console.log("Logged in user:", user);
      } else {
        console.error("No user account found after onSignin.");
      }
    }

function onSignInClick() {
      console.log("Sign-in button clicked.");
      let requestObj = {
	  scopes: ["user.read", 'openid', 'profile']
      };

      clientApplication.loginPopup(requestObj)
        .then(onSignin)
        .catch(function (error) {
          console.error("Login failed:", error);
        });
}

function getOAuthCardResourceUri(activity) {
  if (activity &&
       activity.attachments &&
       activity.attachments[0] &&
       activity.attachments[0].contentType === 'application/vnd.microsoft.card.oauth' &&
       activity.attachments[0].content.tokenExchangeResource) {
	 console.log("OAuth card resource URI found:", activity.attachments[0].content.tokenExchangeResource.uri);
	 return activity.attachments[0].content.tokenExchangeResource.uri;
   }
}

function exchangeTokenAsync(resourceUri) {
  let user = clientApplication.getAccount();
  console.log("Attempting token exchange for resource URI:", resourceUri);
  if (user) {
    let requestObj = {
      scopes: [resourceUri]
    };
    return clientApplication.acquireTokenSilent(requestObj)
      .then(function (tokenResponse) {
	  console.log("Token exchange successful. Token:", tokenResponse.accessToken);
	  return tokenResponse.accessToken;
	})
	.catch(function (error) {
	  console.error("Token exchange failed:", error);
	});
  } else {
    console.warn("No user account found for token exchange.");
    return Promise.resolve(null);
  }
}

async function fetchJSON(url, options = {}) {
    console.log("Fetching JSON from:", url, "with options:", options);
    const res = await fetch(url, {
      ...options,
      headers: {
	...options.headers,
	accept: 'application/json'
      }
    });

    if (!res.ok) {
      console.error("Failed to fetch JSON. Status:", res.status, "StatusText:", res.statusText);
      throw new Error(`Failed to fetch JSON due to ${res.status}`);
    }

    const json = await res.json();
    console.log("Fetched JSON response:", json);
    return json;
} 
</script>

<script>
var clientApplication;
(function (){
  var msalConfig = {
      auth: {
        clientId: '2dead18a-c91b-42e6-b6ab-10876a191cc4',
        authority: 'https://login.microsoftonline.com/f5791d91-daca-4d28-8700-680f7a2f8b6a'
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: false
      }
  };
  if (!clientApplication) {
    clientApplication = new Msal.UserAgentApplication(msalConfig);
    console.log("MSAL client application initialized.");
  }
} ());

(async function main() {
  try {
    if (clientApplication.getAccount() == null) {
      console.log("No cached account found. Triggering login.");
      await clientApplication.loginPopup({ scopes: ["user.read", 'openid', 'profile'] }).then(onSignin);
    } else {
      console.log("Cached account found:", clientApplication.getAccount());
    }

    const theURL = "https://defaultf5791d91daca4d288700680f7a2f8b.6a.environment.api.powerplatform.com/powervirtualagents/botsbyschema/cr90a_websiteQACopilotVMbQUS/directline/token?api-version=2022-03-01-preview";
    console.log("Fetching Direct Line token from:", theURL);
    const { token } = await fetchJSON(theURL);
    console.log("Direct Line token fetched:", token);

    const directLine = window.WebChat.createDirectLine({ token });
    const store = WebChat.createStore({}, ({ dispatch }) => next => action => {
      console.log("Store action dispatched:", action);
      if (action.type === 'DIRECT_LINE/CONNECT_FULFILLED') {
        console.log("Direct Line connected.");
        dispatch({
          type: 'WEB_CHAT/SEND_EVENT',
          payload: {
            name: 'startConversation',
            type: 'event',
            value: { text: "hello" }
          }
        });
      }
      return next(action);
    });

    const styleOptions = {
      hideUploadButton: true
    };

    window.WebChat.renderWebChat(
      {
        directLine: directLine,
        store,
        userID: clientApplication.account?.accountIdentifier || "anonymous",
        styleOptions
      },
      document.getElementById('webchat')
    );
    console.log("WebChat rendered successfully.");
  } catch (err) {
    console.error("An error occurred in main():", err);
  }
})();
</script>
</body>
</html>
